{% extends "base.html" %}
{% block content %}

<!-- Timer Container -->
<div id="main-content" class="timer-container">
  <h2>{{ user_name }}, Ready to Study!</h2>
  <div id="time-display">{{ duration }}</div>

  <!-- Start Timer -->
  <button id="start-btn" class="start-btn">
    <img src="{{ url_for('static', filename='images/play.png') }}" class="btn-icon" alt="Play"> Start Timer
  </button>

  <!-- Stop Timer -->
  <button id="stop-btn" class="stop-btn" disabled>
    <img src="{{ url_for('static', filename='images/stop2.png') }}" class="btn-icon" alt="Stop"> Stop Timer
  </button>

  <!-- Back to Home -->
  <div style="margin-top: 20px;">
    <button class="back-btn" onclick="window.location.href='{{ url_for('user.index') }}'">
      <img src="{{ url_for('static', filename='images/back.png') }}" class="btn-icon" alt="Back">Back to Home
    </button>
  </div>
</div>
<!-- Custom Popup -->
<div id="popup" class="popup hidden">
  <div class="popup-content">
    <h3>‚è∞ Time‚Äôs Up!</h3>
    <p>Take a break, {{ user_name }} üéâ</p>
    <button id="popup-ok">OK</button>
  </div>
</div>


<script>
let duration = {{ duration }} * 60;
let remaining = {{ duration }};  // duration is already in seconds
let interval = null;

function formatTime(seconds) {
  let h = Math.floor(seconds / 3600);
  let m = Math.floor((seconds % 3600) / 60);
  let s = seconds % 60;
  if (h > 0) {
    return [h, m, s].map(v => String(v).padStart(2,'0')).join(":");
  } else {
    return [m, s].map(v => String(v).padStart(2,'0')).join(":");
  }
}

// Set initial display
document.getElementById("time-display").innerText = formatTime(remaining);


document.getElementById("start-btn").onclick = () => {
  if (!interval) {
    interval = setInterval(() => {
      document.getElementById("time-display").innerText = formatTime(remaining);
      if (remaining > 0) {
        remaining--;
      } else {
      // Time's up!
      clearInterval(interval);
      interval = null;

      // Load custom or default sound
      let soundFile = "{{ sound_file if sound_file else url_for('static', filename='sound/i_feel_good.mp3') }}";
      let audio = new Audio(soundFile);
      audio.play().catch(err => console.error("Audio play failed:", err));

      // Show custom popup
      let popup = document.getElementById("popup");
      popup.classList.add("show");

      // Handle OK click
      document.getElementById("popup-ok").onclick = () => {
        audio.pause();
        audio.currentTime = 0;
        popup.classList.remove("show");

        // After popup dismissed ‚Üí confetti + effects
        playConfetti();
        playCelebrationSound();

        // Replace main content
        document.getElementById("main-content").innerHTML = `
            <h2>‚úÖ Session Completed!</h2>
            <p>Great job, {{ user_name }}!</p>
            <button onclick="window.location.href='{{ url_for('user.index') }}'">
              <img src="{{ url_for('static', filename='images/add.png') }}" class="btn-icon"> Start New Session
            </button>
            <button onclick="window.location.href='{{ url_for('sessions.sessions', user_id=user_id) }}'">
              <img src="{{ url_for('static', filename='images/line_graph.png') }}" class="btn-icon"> View All Sessions
            </button>
        `;
      };

      }
    }, 1000);
    document.getElementById("stop-btn").disabled = false;
  }
};

document.getElementById("stop-btn").onclick = () => {
  if (interval) {
    clearInterval(interval);
    interval = null;
    alert("‚èπ Timer Stopped.");
    document.getElementById("stop-btn").disabled = true;
  }
};
</script>
{% endblock %}
